<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Parsing…</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    .bar { width: 100%; background: #eee; height: 12px; border-radius: 6px; overflow: hidden; }
    .bar > div { height: 100%; background: #4caf50; width: 0%; transition: width 0.3s; }
    .small { color: #555; font-size: 12px; }
    .mono { font-family: Consolas, monospace; }
  </style>
</head>
<body>
  <h3>Parsing FDV POLL logs…</h3>
  <div class="bar"><div id="fill"></div></div>
  <div class="small mono" id="txt">Starting…</div>
  <div class="small" id="currwrap" style="margin-top:6px;">
    <strong>Current file:</strong>
    <span id="curr" class="mono" title=""></span>
  <span id="currpct" class="small mono" style="margin-left:6px;color:#777;"></span>
  </div>
  <h4 style="margin-top:14px;">FDV tests seen so far</h4>
  <div id="fdvtable" class="small">Collecting…</div>
  <script>
    const token = "{{ token }}";
    let lastTableHtml = '';
    async function poll() {
      try {
        const res = await fetch(`{{ url_for('poll_status', token='__TOK__') }}`.replace('__TOK__', token), {cache: 'no-store'});
        if (!res.ok) throw new Error('status ' + res.status);
        const data = await res.json();
        const st = data.status || 'unknown';
        const p = data.progress || {};
        const percent = Math.max(0, Math.min(100, Number(p.percent || 0)));
        const filesDone = p.files_done || 0;
        const filesTotal = p.files_total || 0;
        const curr = p.current_file || '';
        const lines = Number(p.lines || 0);
        const linesTotal = Number(p.lines_total || 0);
        const fileLinesDone = Number(p.file_lines_done || 0);
        const fileLinesTotal = Number(p.file_lines_total || 0);
        const filePercent = Math.max(0, Math.min(100, Number(p.file_percent || 0)));
        document.getElementById('fill').style.width = percent.toFixed(1) + '%';
        const totalLineStr = linesTotal ? ` / ${linesTotal.toLocaleString()} lines` : '';
        const fileLineStr = fileLinesTotal ? ` (${fileLinesDone.toLocaleString()} / ${fileLinesTotal.toLocaleString()} in file)` : '';
        document.getElementById('txt').textContent = `${percent.toFixed(1)}% — ${lines.toLocaleString()} lines${totalLineStr}${fileLineStr} — files ${filesDone}/${filesTotal}`;
        try {
          const el = document.getElementById('curr');
          if (el) {
            const base = curr.replaceAll('\\\\','/');
            const name = base.includes('/') ? base.split('/').pop() : base;
            el.textContent = name || '(preparing…)';
            el.title = curr || '';
          }
          const ep = document.getElementById('currpct');
          if (ep) {
            ep.textContent = filePercent ? `(${filePercent.toFixed(1)}%)` : '';
          }
        } catch {}
        if (st === 'done') {
          window.location.href = `{{ url_for('results_view', token='__TOK__') }}`.replace('__TOK__', token);
          return;
        }
        if (st === 'error') {
          document.getElementById('txt').textContent = 'Error: ' + (data.error || 'unknown');
          return;
        }
      } catch (e) {
        // transient errors are okay; keep polling
      }
      setTimeout(poll, 800);
    }
    async function refreshTable() {
      try {
        const bust = Date.now();
        const baseUrl = `{{ url_for('poll_status_fdvtable', token='__TOK__') }}`.replace('__TOK__', token);
        const res = await fetch(baseUrl + `?t=${bust}`, {cache: 'no-store'});
        if (res.ok) {
          const html = await res.text();
          if (html && html !== lastTableHtml) {
            document.getElementById('fdvtable').innerHTML = html;
            lastTableHtml = html;
          }
        }
      } catch {}
      setTimeout(refreshTable, 1500);
    }
    poll();
    refreshTable();
  </script>
</body>
</html>
