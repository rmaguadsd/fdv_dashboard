<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Raw File View</title>
    <style>
  body { font-family: Segoe UI, Arial, sans-serif; margin: 24px; background: #fff; color: #111; }
  .meta { margin-bottom: 12px; color: #222; padding: 10px 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; }
  .meta .lbl { color: #555; font-weight: 600; margin-right: 6px; }
      .nav { margin: 8px 0 14px 0; }
      .layout { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
      .fails { border: 1px solid #ddd; border-radius: 4px; }
      .fails .hd { background: #f4f4f4; padding: 6px 8px; font-weight: 600; border-bottom: 1px solid #ddd; }
    .fails .list { max-height: calc(100vh - 220px); overflow: auto; }
  .fails .item { padding: 6px 8px; border-bottom: 1px solid #eee; font-family: Consolas, Menlo, monospace; white-space: nowrap; }
      .fails .item:last-child { border-bottom: none; }
  .fails .ln { width: auto; display: inline-block; color: #555; }
  .fails .txt { font-size: 11px; color: #666; margin-left: 8px; }
      .fails a { text-decoration: none; color: #1f6feb; }
      .fails .curr { background: #fff7e6; }
  .code { background: #0c0c0c; color: #e5e5e5; padding: 12px; border-radius: 4px; font-family: Consolas, Menlo, monospace; font-size: 12px; line-height: 1.25; max-height: calc(100vh - 220px); overflow: auto; }
      .line { white-space: pre; }
      .ln { display: inline-block; width: 64px; color: #888; }
  /* Fail lines: light red background; Selected line overrides to yellow */
  .fail { background: #332222; color: #ffdddd; }
  .current { background: #fff59b; color: #111; }
      a { color: #4ea1ff; }
      .disabled { color: #777; pointer-events: none; }
    </style>
  </head>
  <body>
  <div class="meta">
    <div class="file"><span class="lbl">File:</span> <strong>{{ filename }}</strong></div>
    {% if orig_filename and orig_filename != filename %}
      <div style="color:#666; font-size:12px; margin-top:2px;">Original: {{ orig_filename }}</div>
    {% endif %}
    {% if filename_base and filename_base != filename %}
      <div style="color:#666; font-size:12px; margin-top:2px;">Basename: {{ filename_base }}</div>
    {% endif %}
    <div>around line {{ target_line }} {% if total is defined %}(fail {{ (idx + 1) if idx is defined else 1 }} of {{ total }}){% endif %}{% if note %} — {{ note }}{% endif %}</div>
    <div class="small" style="color:#444; margin-top:2px;">
      {% set lim = request.args.get('limit', None) %}
      {% if lim is not none and lim|lower == 'none' %}
        Mode: using PASS/FAIL flags from logs (limit=none).
      {% elif lim is not none and lim|length > 0 %}
        Mode: threshold by RBER limit {{ lim }}.
      {% else %}
        Mode: threshold by RBER limit (unspecified; provide &limit= or select on main page).
      {% endif %}
    </div>
    {% if attempted_paths and attempted_paths|length > 0 %}
      <div style="color:#8a6d3b; font-size:12px; margin-top:6px;">Tried:
        {% for p in attempted_paths %}
          <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 100%;">{{ p }}</div>
        {% endfor %}
      </div>
    {% elif row_file_hint and row_file_hint|length > 0 and (not ('/' in (filename or '') or '\\' in (filename or ''))) %}
      <div style="color:#666; font-size:12px; margin-top:6px;">From data: {{ row_file_hint }}</div>
    {% elif read_failed %}
      <div style="color:#666; font-size:12px; margin-top:6px;">Could not open a source file. If you know the logs root, add it with <code>&dir=...</code> in the URL. Current search root: {{ search_root or '(none)' }}.</div>
    {% endif %}
    {% if filename and not ('/' in filename or '\\' in filename) %}
      <div style="color:#777; font-size:12px; margin-top:2px;">Hint: "{{ filename }}" looks like a token. We try to expand it using the FDV rows and search root above.</div>
    {% endif %}
    {% if sel %}
      <div style="color:#555; font-size:12px; margin-top:4px;">fdv={{ sel.fdv }}; pr={{ sel.pr }}; vcc={{ sel.vcc }}; tm={{ sel.tm }}; temp={{ sel.temp }}</div>
    {% endif %}
    {% if src_options and src_options|length > 1 %}
      <form method="get" style="margin-top:6px;">
        <input type="hidden" name="fdv" value="{{ sel.fdv }}" />
        <input type="hidden" name="pr" value="{{ sel.pr }}" />
        <input type="hidden" name="vcc" value="{{ sel.vcc }}" />
        <input type="hidden" name="tm" value="{{ sel.tm }}" />
        <input type="hidden" name="temp" value="{{ sel.temp }}" />
        <input type="hidden" name="limit" value="{{ request.args.get('limit','') }}" />
        <input type="hidden" name="context" value="{{ request.args.get('context','80') }}" />
        <input type="hidden" name="idx" value="0" />
        {% if request.args.get('testname') %}<input type="hidden" name="testname" value="{{ request.args.get('testname') }}" />{% endif %}
        {% if request.args.get('fuseid') %}<input type="hidden" name="fuseid" value="{{ request.args.get('fuseid') }}" />{% endif %}
        {% if request.args.get('plane') %}<input type="hidden" name="plane" value="{{ request.args.get('plane') }}" />{% endif %}
        {% if request.args.get('op') %}<input type="hidden" name="op" value="{{ request.args.get('op') }}" />{% endif %}
        {% if search_root %}<input type="hidden" name="dir" value="{{ search_root }}" />{% endif %}
        <label class="lbl">Source file:</label>
        <select name="src" onchange="this.form.submit()">
          <option value="">(all)</option>
          {% for s in src_options %}
            <option value="{{ s }}" {% if src_selected and (s == src_selected or (s|basename) == (src_selected|basename)) %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </form>
    {% endif %}
  </div>
    <div class="nav">
      {% if prev_url %}<a href="{{ prev_url }}">← Prev fail</a>{% else %}<span class="disabled">← Prev fail</span>{% endif %}
      &nbsp;|&nbsp;
      {% if next_url %}<a href="{{ next_url }}">Next fail →</a>{% else %}<span class="disabled">Next fail →</span>{% endif %}
      &nbsp;|&nbsp;
      <a href="{{ back_url }}">Back</a>
    </div>
    <div class="layout">
      <div class="fails">
        <div class="hd">Failing lines ({{ total }})</div>
        <div class="list">
          {% if fail_items and fail_items|length > 0 %}
            {% for f in fail_items %}
              <div class="item{% if f.is_current %} curr{% endif %}">
                <a href="{{ f.url }}"><span class="ln">{{ f.ln }}</span></a><span class="txt">{{ f.content }}</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="item">No explicit line numbers available.</div>
          {% endif %}
        </div>
      </div>
      <div>
        <div class="code">
          {% for r in snippet %}
            <div class="line{% if r.is_target %} fail{% endif %}{% if r.is_current %} current{% endif %}"><span class="ln">{{ '%6d'|format(r.ln) }}</span> {{ r.content }}</div>
          {% endfor %}
        </div>
      </div>
    </div>
  <div class="nav">
      {% if prev_url %}<a href="{{ prev_url }}">← Prev fail</a>{% else %}<span class="disabled">← Prev fail</span>{% endif %}
      &nbsp;|&nbsp;
      {% if next_url %}<a href="{{ next_url }}">Next fail →</a>{% else %}<span class="disabled">Next fail →</span>{% endif %}
      &nbsp;|&nbsp;
      <a href="{{ back_url }}">Back</a>
    </div>
    <script>
      (function(){
        try {
          var container = document.querySelector('.code');
          var el = container ? container.querySelector('.line.current') : null;
          if (container && el) {
            var y = el.offsetTop - 120; // position within container
            if (y < 0) y = 0;
            container.scrollTo({ top: y, left: 0, behavior: 'auto' });
          }
        } catch(e) { /* ignore */ }
      })();
    </script>
  </body>
</html>
