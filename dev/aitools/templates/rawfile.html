<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Raw File â€” Fail Rows</title>
    <style>
      body { font-family: Segoe UI, Arial, sans-serif; margin: 16px; background: #fff; color: #111; }
      .meta { margin-bottom: 8px; color: #222; padding: 8px 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; }
      .meta .lbl { color: #555; font-weight: 600; margin-right: 6px; }
      .fails { border: 1px solid #ddd; border-radius: 4px; }
      .fails .hd { background: #f4f4f4; padding: 6px 8px; font-weight: 600; border-bottom: 1px solid #ddd; }
      .fails .list { max-height: calc(100vh - 180px); overflow: auto; }
  table { width: 100%; border-collapse: collapse; table-layout: auto; }
      th, td { border-bottom: 1px solid #eee; padding: 2px 4px; font-size: 11px; line-height: 1.2; font-family: Consolas, Menlo, monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      /* Show raw lines in full: wrap and no inner scrollbars */
      td.col-raw { white-space: pre-wrap; word-break: break-word; overflow: visible; text-overflow: initial; }
  /* Raw file column: allow the table to auto-size this column based on content */
  td.col-file { white-space: nowrap; }
  th { border-bottom-color: #ddd; background: #fafafa; cursor: pointer; position: sticky; top: 0; }
  /* Sort indicators */
  th.sort-asc::after { content: " \25B2"; font-size: 10px; color: #666; }
  th.sort-desc::after { content: " \25BC"; font-size: 10px; color: #666; }
      .rber-low { background: #e8f5e9; }
      .rber-mid { background: #fff8e1; }
      .rber-high { background: #ffebee; }
      .filters { display: grid; grid-template-columns: 90px 160px 120px 220px 1fr; gap: 6px; padding: 6px; background: #f7f7f7; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 1; }
      .filters input { width: 100%; padding: 3px 4px; font-size: 12px; font-family: Segoe UI, Arial, sans-serif; }
      .fails .item { padding: 4px 6px; border-bottom: 1px solid #eee; font-family: Consolas, Menlo, monospace; white-space: nowrap; font-size: 11px; line-height: 1.2; }
      .fails .item:last-child { border-bottom: none; }
      .ln { display: inline-block; width: 64px; color: #555; }
      .txt { font-size: 11px; color: #333; margin-left: 8px; }
    </style>
  </head>
  <body>
    <div class="meta">
      {% if sel %}
        <div style="color:#555; font-size:12px;">fdv={{ sel.fdv }}; pr={{ sel.pr }}; vcc={{ sel.vcc }}; tm={{ sel.tm }}; temp={{ sel.temp }}</div>
      {% endif %}
      {% if note %}<div style="color:#666; font-size:12px; margin-top:4px;">{{ note }}</div>{% endif %}
    </div>
    <div class="fails">
      <div class="hd">Failing lines ({{ total }})</div>
      {% if fail_items and fail_items|length > 0 %}
        <div class="list">
          <div class="filters">
            <input type="text" id="fltLine" placeholder="Line" />
            <input type="text" id="fltFuse" placeholder="FuseID" />
            <input type="text" id="fltRber" placeholder="RBER >= ..." />
            <input type="text" id="fltFile" placeholder="File contains..." />
            <input type="text" id="fltRaw" placeholder="Raw contains..." />
          </div>
          <table id="failsTable">
            <thead>
              <tr>
                <th data-key="ln" data-type="num" style="width:90px; text-align:left;">Line</th>
                <th data-key="fuseid" data-type="str" style="width:160px; text-align:left;">FuseID</th>
                <th data-key="rber" data-type="num" style="width:120px; text-align:left;">RBER</th>
                <th data-key="file_base" data-type="str" style="text-align:left;">Raw file</th>
                <th data-key="content" data-type="str" style="text-align:left;">Raw line</th>
              </tr>
            </thead>
            <tbody>
              {% for f in fail_items %}
                {% set rclass = 'rber-low' if (f.rber is defined and f.rber is not none and f.rber < 1e-4) else ('rber-mid' if (f.rber is defined and f.rber is not none and f.rber < 1e-2) else 'rber-high') %}
                <tr>
                  <td>{{ '%6d'|format(f.ln) }}</td>
                  <td>{{ f.fuseid }}</td>
                  <td class="{{ rclass }}" data-rber="{{ f.rber if f.rber is not none else '' }}">{{ f.rber_fmt }}</td>
                  <td class="col-file" title="{{ f.file }}">{{ f.file_base }}</td>
                  <td class="col-raw" title="{{ f.content }}">{{ f.content }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="list">
          <div class="item">No explicit line numbers available.</div>
        </div>
      {% endif %}
    </div>
    <script>
      (function(){
        // Simple client-side filter and sort, scoped to this page only
        var tbl = document.getElementById('failsTable');
        if (!tbl) return;
        var tbody = tbl.querySelector('tbody');
        var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
        var inputs = {
          line: document.getElementById('fltLine'),
          fuse: document.getElementById('fltFuse'),
          rber: document.getElementById('fltRber'),
          file: document.getElementById('fltFile'),
          raw: document.getElementById('fltRaw')
        };
        function parseNum(s){ var v = parseFloat(String(s||'').trim()); return isNaN(v) ? null : v; }
        function applyFilters(){
          var qLine = (inputs.line && inputs.line.value || '').trim();
          var qFuse = (inputs.fuse && inputs.fuse.value || '').trim().toLowerCase();
          var qRber = parseNum(inputs.rber && inputs.rber.value);
          var qFile = (inputs.file && inputs.file.value || '').trim().toLowerCase();
          var qRaw = (inputs.raw && inputs.raw.value || '').trim().toLowerCase();
          rows.forEach(function(tr){
            var tds = tr.children;
            var ln = (tds[0].textContent||'').trim();
            var fuse = (tds[1].textContent||'').trim().toLowerCase();
            var rberAttr = tds[2].getAttribute('data-rber');
            var rber = rberAttr ? parseFloat(rberAttr) : null;
            var fbase = (tds[3].textContent||'').toLowerCase();
            var raw = (tds[4].textContent||'').toLowerCase();
            var ok = true;
            if (qLine) { ok = ok && ln.indexOf(qLine) >= 0; }
            if (ok && qFuse) { ok = ok && fuse.indexOf(qFuse) >= 0; }
            if (ok && (qRber !== null)) { ok = ok && (rber !== null) && (rber >= qRber); }
            if (ok && qFile) { ok = ok && fbase.indexOf(qFile) >= 0; }
            if (ok && qRaw) { ok = ok && raw.indexOf(qRaw) >= 0; }
            tr.style.display = ok ? '' : 'none';
          });
        }
        ['input','change','keyup'].forEach(function(evt){
          if (inputs.line) inputs.line.addEventListener(evt, applyFilters);
          if (inputs.fuse) inputs.fuse.addEventListener(evt, applyFilters);
          if (inputs.rber) inputs.rber.addEventListener(evt, applyFilters);
          if (inputs.file) inputs.file.addEventListener(evt, applyFilters);
          if (inputs.raw) inputs.raw.addEventListener(evt, applyFilters);
        });
        applyFilters();
        // Sort: click header toggles asc/desc
        var sortState = {};
        var ths = tbl.querySelectorAll('th');
        ths.forEach(function(th, idx){
          th.addEventListener('click', function(){
            var key = th.getAttribute('data-key') || String(idx);
            var type = th.getAttribute('data-type') || 'str';
            // Reset indicators on other headers
            ths.forEach(function(other){ if (other !== th) { other.classList.remove('sort-asc','sort-desc'); } });
            sortState[key] = (sortState[key] === 'asc') ? 'desc' : 'asc';
            var dir = sortState[key] === 'asc' ? 1 : -1;
            th.classList.toggle('sort-asc', dir === 1);
            th.classList.toggle('sort-desc', dir === -1);
            var arr = rows.slice();
            arr.sort(function(a,b){
              var ax = a.children[idx]; var bx = b.children[idx];
              var av = ax ? ax.getAttribute('data-rber') || ax.textContent : '';
              var bv = bx ? bx.getAttribute('data-rber') || bx.textContent : '';
              if (type === 'num') { av = parseFloat(av); bv = parseFloat(bv); if (isNaN(av)) av = -Infinity; if (isNaN(bv)) bv = -Infinity; }
              else { av = String(av).toLowerCase(); bv = String(bv).toLowerCase(); }
              if (av < bv) return -1 * dir; if (av > bv) return 1 * dir; return 0;
            });
            // Reattach in new order (keep current filtering)
            arr.forEach(function(tr){ tbody.appendChild(tr); });
            // Update rows reference so filters operate on current order
            rows = arr;
          });
        });
      })();
    </script>
  </body>
  </html>
