<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FDV Report v2 — Tests</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .flash { color: #b00; margin: 8px 0; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 13px; }
    th { background: #f5f5f5; position: sticky; top: 0; }
    form { margin: 10px 0; }
    .small { font-size: 12px; color: #666; }
  .pct-ok { background: #e8f9e8; color: #167a16; font-weight: 600; }
  .pct-warn { background: #ffe6e6; color: #a11; }
  .pct-bad { background: #ff4d4d; color: #fff; font-weight: 700; }
  </style>
</head>
<body>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash">{{ messages|join(' — ') }}</div>
    {% endif %}
  {% endwith %}

  <h2>FDV Report v2 — Testnames</h2>
  {% if sel_rows and sel_rows|length %}
    <div class="small">Selected FDV rows:</div>
    <table>
      <thead>
        <tr><th>FDV Test</th><th>PR</th><th>VCC</th><th>TM</th><th>Temp</th></tr>
      </thead>
      <tbody>
        {% for s in sel_rows %}
          <tr>
            <td>{{ s.fdv }}</td>
            <td>{{ s.pr }}</td>
            <td>{{ s.vcc }}</td>
            <td>{{ s.tm }}</td>
            <td>{{ s.temp }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  <p class="small">Click a row (or its checkbox) to select it for plotting; then click “Plot Variability”.</p>

  <div class="small" style="margin:6px 0;">
  RBER limit: <input id="limitDisplay" type="text" value="{{ ('' if (limit is none) else ('%.3g' % limit)) }}" size="8" disabled />
    <span>(PASS &lt; limit, FAIL ≥ limit; blank = using PASS/FAIL from logs)</span>
  </div>
  {% set ns = namespace(show_plane=false) %}
  {% for r in stats %}
    {% if r.get('plane','') in ['SP','MP'] %}{% set ns.show_plane = true %}{% endif %}
  {% endfor %}
  <form id="plotForm" method="post" action="{{ url_for('report_tests_variability', token=token) }}">
    {% for f in fdvs %}
      <input type="hidden" name="fdv" value="{{ f }}" />
    {% endfor %}
    <div class="small" style="margin:6px 0 8px 0;">
      <label><input type="checkbox" name="split_plane_addr" value="1" {% if split_plane_addr %}checked{% endif %} /> Generate separate chart per plane address</label>
    </div>
  <table id="testsTable">
      <thead>
        <tr>
    <th>Select</th>
          <th>Testname</th>
          <th>PR</th>
          <th>VCC</th>
          <th>TM</th>
          <th>Temp</th>
          <th>Pagemap</th>
          {% if ns.show_plane %}<th>Plane-Op</th>{% endif %}
          <th>PlaneAddr</th>
          <th>Blk</th>
          <th>FuseID</th>
          <th>Count</th>
          <th>PASS</th>
          <th>FAIL</th>
          <th>% FAIL</th>
          <th>Min</th>
          <th>Max</th>
          <th>Mean</th>
          <th>Stdev</th>
          <th>Median</th>
        </tr>
      </thead>
      <tbody>
  {% for r in stats %}
  <tr class="selRow">
    <td>
      <input type="checkbox" name="sel" value="{{ r['testname'] }}|{{ r['pr'] }}|{{ r['fuseid'] }}|{{ r.get('vcc','') }}|{{ r.get('tm','') }}|{{ r.get('temp','') }}" />
    </td>
          <td>{{ r['testname'] }}</td>
          <td>{{ r['pr'] }}</td>
          <td>{{ r.get('vcc','') }}</td>
          <td>{{ r.get('tm','') }}</td>
          <td>{{ r.get('temp','') }}</td>
          <td>{{ r.get('pagemap', r.get('product_type','')) }}</td>
          {% if ns.show_plane %}<td>{{ r.get('plane','') or r.get('plane_op','') }}</td>{% endif %}
          <td>{{ r.get('plane_addr','') }}</td>
          <td>{{ r.get('blk_addr','') }}</td>
          <td>{{ r['fuseid'] }}</td>
          <td>{{ r['count'] }}</td>
          <td>{{ r.get('pass_n', r.get('pass','')) }}</td>
          <td>
            {% set failn = r.get('fail_n', r.get('fail','')) %}
            {% if failn and (failn|int) > 0 %}
              {# Use precise selectors so the server can pick the exact row and its fdv_file #}
              <!-- removed report_fails link -->
                pr=r['pr'], vcc=r.get('vcc',''), tm=r.get('tm',''), temp=r.get('temp',''),
                testname=r['testname'], fuseid=r['fuseid'],
                limit=(('' if (limit is none) else ('%.3g' % limit))), dir=used_dir
              ) }}" data-fdv-limit="1">{{ failn }}</a>
            {% else %}
              {{ failn }}
            {% endif %}
          </td>
          {% set total = (r['count']|int if r['count'] is not none else 0) %}
          {% set f = (r.get('fail_n', r.get('fail',''))|int) %}
          {% set pct = (100.0 * f / total) if total > 0 else 0.0 %}
          <td {% if total > 0 %}class="{% if pct == 0 %}pct-ok{% elif pct <= 25 %}pct-warn{% else %}pct-bad{% endif %}"{% endif %}>
            {% if total > 0 %}{{ pct | round(1) }}%{% endif %}
          </td>
          <td>{{ r['min'] }}</td>
          <td>{{ r['max'] }}</td>
          <td>{{ r['mean'] }}</td>
          <td>{{ r['stdev'] }}</td>
          <td>{{ r['median'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div style="margin-top:8px; display:flex; gap:12px; align-items:center;">
      <a href="#" onclick="return plotVariability();">Plot Variability</a>
      <a href="#" onclick="return showData(false);">Show Data (first 10)</a>
      <a href="#" onclick="return showData(true);">Show Data (JSON)</a>
    </div>
  </form>

  <script>
    (function(){
      const table = document.getElementById('testsTable');
      if (!table) return;
      table.addEventListener('click', function(ev){
        const tr = ev.target.closest('tr.selRow');
        if (!tr) return;
        // Avoid toggling if the click was on a link or the checkbox itself
        if (ev.target.tagName === 'A') return;
        const cb = tr.querySelector('input[type="checkbox"][name="sel"]');
        if (ev.target === cb) return;
        if (cb) { cb.checked = !cb.checked; }
      });
    })();

    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }

    function effectiveLimitString() {
      // Resolve from URL param first (if present), else cookie, else empty string means PASS/FAIL-from-logs
      const params = new URLSearchParams(window.location.search);
      if (params.has('limit')) {
        return params.get('limit') || '';
      }
      const c = getCookie('fdv2_limit');
      return (c === null) ? '' : c;
    }

    function showData(asJson) {
      try {
        const form = document.getElementById('plotForm');
        if (!form) return;
        const fdvs = Array.from(form.querySelectorAll('input[name="fdv"]')).map(i => (i.value || '').trim()).filter(Boolean);
        const sels = Array.from(form.querySelectorAll('input[name="sel"]:checked')).map(i => (i.value || '').trim()).filter(Boolean);
        if (!fdvs.length) { alert('No FDV selection.'); return; }
        if (!sels.length) { alert('Select at least one testname row.'); return; }
  const params = new URLSearchParams();
        fdvs.forEach(f => params.append('fdv', f));
        sels.forEach(s => params.append('sel', s));
  // keep same limit mode for data endpoint
  params.append('limit', effectiveLimitString());
        params.append('fallback', '1');
        params.append('include', 'all');
        if (asJson) params.append('format', 'json');
        const base = "{{ url_for('report_tests_variability_data', token=token) }}";
        const url = base + '?' + params.toString();
        window.open(url, '_blank');
      } catch (e) {
        console.error(e);
      }
    }

    function plotVariability() {
      try {
        const form = document.getElementById('plotForm');
        if (!form) return false;
        const fdvs = Array.from(form.querySelectorAll('input[name="fdv"]')).map(i => (i.value || '').trim()).filter(Boolean);
        const sels = Array.from(form.querySelectorAll('input[name="sel"]:checked')).map(i => (i.value || '').trim()).filter(Boolean);
        if (!fdvs.length) { alert('No FDV selection.'); return false; }
        if (!sels.length) { alert('Select at least one testname row.'); return false; }
  const params = new URLSearchParams();
        fdvs.forEach(f => params.append('fdv', f));
        sels.forEach(s => params.append('sel', s));
        // persist split_plane_addr option
        const split = form.querySelector('input[name="split_plane_addr"]');
        if (split && split.checked) params.append('split_plane_addr', '1');
  params.append('limit', effectiveLimitString());
        const base = "{{ url_for('report_tests_variability', token=token) }}";
        window.location.href = base + '?' + params.toString();
        return false;
      } catch (e) {
        console.error(e);
        return false;
      }
    }
  </script>

  <p class="small"><a href="{{ url_for('report_home') }}?token={{ token }}">Back</a></p>
</body>
</html>
