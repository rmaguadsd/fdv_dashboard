<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FDV Report Table</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 6px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; font-size: 12px; }
    th { background: #f5f5f5; position: sticky; top: 0; }
    .small { font-size: 11px; color:#555; }
    .pct-ok { background:#e8f9e8; color:#167a16; font-weight:600; }
    .pct-warn { background:#ffe6e6; color:#a11; }
    .pct-bad { background:#ff4d4d; color:#fff; font-weight:700; }
    .comments-cell { white-space: nowrap; font-size: 10px; max-width: 400px; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body>
  {% if job_id %}<div class="small" style="margin:2px 0 6px 0;">Job ID: <span class="mono">{{ job_id }}</span>{% if token %} (token {{ token }}){% endif %}</div>{% endif %}
  {% if not stats or not (stats|length) %}
    <div class="small" style="color:#666;">No results yet.</div>
  {% else %}
    <table>
      <thead>
        <tr>
          <th>FDV Test</th><th>PR</th><th>VCC</th><th>TM</th><th>Temp</th><th>Pagemap</th><th>Units</th><th>Count</th><th>PASS</th><th>FAIL</th><th>% FAIL</th><th>Min</th><th>Max</th><th>Mean</th><th>Stdev</th><th>Median</th><th>Comment</th><th>Start</th><th>End</th>
        </tr>
      </thead>
      <tbody>
        {% for r in stats %}
        {% set total = (r['count']|int if r['count'] is not none else 0) %}
        {% set failn = (r.get('fail_n', r.get('fail', 0))|int) %}
        {% set passn = (r.get('pass_n', r.get('pass', 0))|int) %}
        {% set pct_fail = ( (failn / total * 100.0) if (total>0) else 0.0 ) %}
        <tr>
          <td>{{ r['fdv_file'] }}</td>
          <td>{{ r['pr'] }}</td>
          <td>{{ r['vcc'] }}</td>
          <td>{{ r['tm'] }}</td>
          <td>{{ r['temp'] }}</td>
          <td>{{ r.get('pagemap', r.get('product_type','')) }}</td>
          <td>{{ r.get('valid_fuseid_count','') }}</td>
          <td>{{ r['count'] }}</td>
          <td>{{ passn }}</td>
          <td>{{ failn }}</td>
          <td class="{% if pct_fail==0 %}pct-ok{% elif pct_fail<20 %}pct-warn{% else %}pct-bad{% endif %}">{{ '%.2f' % pct_fail }}</td>
          <td>{{ '%.3g' % r['min'] if r['min'] is not none else '' }}</td>
          <td>{{ '%.3g' % r['max'] if r['max'] is not none else '' }}</td>
          <td>{{ '%.3g' % r['mean'] if r['mean'] is not none else '' }}</td>
          <td>{{ '%.3g' % r['stdev'] if r['stdev'] is not none else '' }}</td>
          <td>{{ '%.3g' % r['median'] if r['median'] is not none else '' }}</td>
          <td class="comments-cell">{{ r.get('comment','') }}</td>
          <td>{{ r.get('start_time','') }}</td>
          <td>{{ r.get('end_time','') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</body>
</html>
