<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FDV Active Jobs</title>
  <style>
    body { font-family: Arial, sans-serif; margin:16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border:1px solid #ccc; padding:4px 6px; font-size:12px; }
    th { background:#f5f5f5; position:sticky; top:0; }
    .small { font-size:11px; color:#555; }
    .status-running { color:#0a5; font-weight:600; }
    .status-done { color:#064; }
    .status-error { color:#b00; font-weight:600; }
    .mono { font-family: Consolas, monospace; }
  </style>
</head>
<body>
  <h2>Active FDV Jobs</h2>
  <div class="small">Auto-refreshing every 2s. Use JSON API at <code>/api/jobs</code>.</div>
  <table id="jobsTbl" style="margin-top:10px;">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Status</th>
        <th>%</th>
        <th>Files</th>
        <th>Lines</th>
        <th>Updated (s ago)</th>
        <th>Links</th>
      </tr>
    </thead>
    <tbody id="jobsBody">
      <tr><td colspan="7" class="small">Loadingâ€¦</td></tr>
    </tbody>
  </table>
<script>
async function refreshJobs(){
  try{
    const res = await fetch('/api/jobs',{cache:'no-store'});
    if(!res.ok) throw new Error('status '+res.status);
    const data = await res.json();
    const body = document.getElementById('jobsBody');
    const jobs = data.jobs || [];
    if(!jobs.length){ body.innerHTML = '<tr><td colspan="7" class="small">No jobs yet.</td></tr>'; return; }
    let html='';
    for(const j of jobs){
      const cls = 'status-'+(j.status||'unknown');
      const pct = (j.percent!=null)? (Number(j.percent).toFixed(1)+'%') : '';
      const files = (j.files_done!=null)? `${j.files_done}/${j.files_total||''}` : '';
      const upd = (j.updated_secs_ago!=null)? j.updated_secs_ago : '';
        const reportLink = j.report_ready ? `<a href="${j.report_url}" target="_blank">report</a>` : `<span style="color:#999;cursor:not-allowed;" title="Report not ready yet">report</span>`;
        const progressLink = (j.status === 'done' || j.status === 'error')
          ? `<span style="color:#999;cursor:not-allowed;" title="Parsing finished">progress</span>`
          : `<a href="${j.progress_url}" target="_blank">progress</a>`;
      html += `<tr>`+
        `<td class="mono">${j.job_id}</td>`+
        `<td class="${cls}">${j.status}</td>`+
        `<td>${pct}</td>`+
        `<td>${files}</td>`+
        `<td>${j.lines||''}</td>`+
        `<td>${upd}</td>`+
          `<td class="small">${progressLink} | ${reportLink} | <a href="${j.status_url}" target="_blank">json</a></td>`+
        `</tr>`;
    }
    body.innerHTML = html;
  }catch(e){ /* ignore transient errors */ }
  setTimeout(refreshJobs, 2000);
}
refreshJobs();
</script>
</body>
</html>
