<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FDV Active Jobs</title>
  <style>
    body { font-family: Arial, sans-serif; margin:16px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border:1px solid #ccc; padding:4px 6px; font-size:12px; }
    th { background:#f5f5f5; position:sticky; top:0; }
    .small { font-size:11px; color:#555; }
    .status-running { color:#0a5; font-weight:600; }
    .status-done { color:#064; }
    .status-error { color:#b00; font-weight:600; }
    .status-paused { color:#c78100; font-weight:600; }
    .mono { font-family: Consolas, monospace; }
  th.job-name-col, td.job-name-cell { width:416px; min-width:416px; max-width:416px; }
  td.links-col { white-space:nowrap; }
  th.job-id-col, td.job-id { width:80px; min-width:80px; max-width:80px; }
  th.eta-col, td.eta-col { width:70px; min-width:70px; max-width:70px; text-align:right; }
  th.links-col, td.links-col { width:120px; min-width:120px; max-width:120px; }
  th.status-col, td.status-col { width:70px; min-width:70px; max-width:70px; text-align:center; }
  th.pct-col, td.pct-col { width:55px; min-width:55px; max-width:55px; text-align:right; }
  th.files-col, td.files-col { width:70px; min-width:70px; max-width:70px; text-align:center; }
  th.lines-col, td.lines-col { width:70px; min-width:70px; max-width:70px; text-align:right; }
  th.start-col, td.start-col { width:70px; min-width:70px; max-width:70px; text-align:right; }
  th.end-col, td.end-col { width:70px; min-width:70px; max-width:70px; text-align:right; }
  .job-name-cell { outline:none; background:transparent; cursor:text; }
  .job-name-cell:focus { background:#f0f6ff; box-shadow:0 0 0 1px #bcd inset; }
  .job-name-cell:hover { background:#f8f8f8; }
  .job-name-cell.saving { background:#fff6dd !important; }
  .job-name-cell.saved { background:#e9f9e9 !important; transition: background .6s ease; }
  </style>
</head>
<body>
  <h2>Active FDV Jobs</h2>
  <div class="small">Auto-refreshing every 2s. Use JSON API at <code>/api/jobs</code>.</div>
  <table id="jobsTbl" style="margin-top:10px;">
    <thead>
      <tr>
  <th class="job-id-col">Job ID</th>
  <th class="job-name-col">Job Name</th>
  <th class="status-col">Status</th>
  <th class="pct-col">%</th>
  <th class="files-col">Files</th>
  <th class="lines-col">Lines</th>
  <th class="start-col">Start</th>
  <th class="end-col">End</th>
  <th class="eta-col">ETA</th>
  <th class="links-col">Links</th>
      </tr>
    </thead>
    <tbody id="jobsBody">
  <tr><td colspan="10" class="small">Loadingâ€¦</td></tr>
    </tbody>
  </table>
<script>
window.JOB_NAME_EDIT_ACTIVE = false;
async function refreshJobs(){
  if(window.JOB_NAME_EDIT_ACTIVE){
    setTimeout(refreshJobs, 2000);
    return;
  }
  try{
    const res = await fetch('/api/jobs',{cache:'no-store'});
    if(!res.ok) throw new Error('status '+res.status);
    const data = await res.json();
    const body = document.getElementById('jobsBody');
    const jobs = data.jobs || [];
  if(!jobs.length){ body.innerHTML = '<tr><td colspan="10" class="small">No jobs yet.</td></tr>'; return; }
    let html='';
    for(const j of jobs){
      const cls = 'status-'+(j.status||'unknown');
      const pct = (j.percent!=null)? (Number(j.percent).toFixed(1)+'%') : '';
      const files = (j.files_done!=null)? `${j.files_done}/${j.files_total||''}` : '';
      // Use server-provided overall ETA
      let etaTxt='';
      const s = (typeof j.eta_overall_secs==='number') ? j.eta_overall_secs : (typeof j.eta_secs==='number'? j.eta_secs : null);
      if(s!=null && s>0){
        if(s < 120) etaTxt = Math.round(s)+'s';
        else if(s < 7200) etaTxt = Math.round(s/60)+'m';
        else etaTxt = Math.round(s/3600)+'h';
      }
        const reportLink = j.report_ready ? `<a href="${j.report_url}" target="_blank">report</a>` : `<span style="color:#999;cursor:not-allowed;" title="Report not ready yet">report</span>`;
        const progressLink = (j.status === 'done' || j.status === 'error')
          ? `<span style="color:#999;cursor:not-allowed;" title="Parsing finished">progress</span>`
          : `<a href="${j.progress_url}" target="_blank">progress</a>`;
      const nameVal = (j.name||'');
      const nameId = `name_${j.job_id}`;
      html += `<tr>`+
  `<td class="mono job-id">${j.job_id}</td>`+
  `<td class="job-name-cell" id="${nameId}" contenteditable="true" data-job="${j.job_id}" data-last="${nameVal.replace(/"/g,'&quot;')}" style="min-width:416px;min-height:18px;padding:2px;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${nameVal.replace(/</g,'&lt;')}</td>`+
  `<td class="${cls} status-col">${j.status}</td>`+
  `<td class="pct-col">${pct}</td>`+
  `<td class="files-col">${files}</td>`+
  `<td class="lines-col">${j.lines||''}</td>`+
  `<td class="start-col">${j.created_hms||''}</td>`+
  `<td class="end-col">${j.ended_hms||''}</td>`+
  `<td class="eta-col">${etaTxt}</td>`+
          (()=>{
            let controls = [];
            const canPause = (j.status === 'running');
            const canContinue = (j.status === 'paused');
            const canDelete = (j.status !== 'deleted');
            if(canPause){ controls.push(`<a href="#" data-act="pause" data-job="${j.job_id}">pause</a>`); }
            else if(canContinue){ controls.push(`<a href="#" data-act="continue" data-job="${j.job_id}">continue</a>`); }
            else { controls.push(`<span style="color:#999;">pause</span>`); }
            if(canDelete){ controls.push(`<a href="#" data-act="delete" data-job="${j.job_id}">delete</a>`); }
            else { controls.push(`<span style="color:#999;">delete</span>`); }
            const links = `${progressLink} | ${reportLink} | <a href="${j.status_url}" target="_blank">json</a>`;
            return `<td class="small links-col">${links} | ${controls.join(' | ')}</td>`;
          })()+
        `</tr>`;
    }
    body.innerHTML = html;
    attachNameEditors();
  }catch(e){ /* ignore transient errors */ }
  setTimeout(refreshJobs, 2000);
}
refreshJobs();

// Debounced job name saving logic (full-cell editable)
const _jobNameTimers = {};
function attachNameEditors(){
  const editable = document.querySelectorAll('td.job-name-cell[contenteditable]');
  for(const el of editable){
    if(el._hasHandler) continue;
    el._hasHandler = true;
    el.addEventListener('focus', ()=>{ window.JOB_NAME_EDIT_ACTIVE = true; });
    el.addEventListener('blur', ()=>{ setTimeout(()=>{ window.JOB_NAME_EDIT_ACTIVE = false; }, 50); });
    el.addEventListener('input', ()=>{
      const job = el.getAttribute('data-job');
      el.classList.add('saving');
      if(_jobNameTimers[job]) clearTimeout(_jobNameTimers[job]);
      const txt = el.textContent || '';
      _jobNameTimers[job] = setTimeout(()=>{ saveJobName(job, txt, el); }, 700);
    });
    el.addEventListener('blur', ()=>{
      const job = el.getAttribute('data-job');
      const txt = el.textContent || '';
      const last = el.getAttribute('data-last') || '';
      if(txt !== last){
        if(_jobNameTimers[job]) clearTimeout(_jobNameTimers[job]);
        saveJobName(job, txt, el);
      }
    });
  }
}
document.addEventListener('click', async (e)=>{
  const a = e.target.closest('a[data-act]');
  if(!a) return;
  e.preventDefault();
  const act = a.getAttribute('data-act');
  const job = a.getAttribute('data-job');
  if(!job) return;
  let endpoint = `/api/job/${job}/${act}`;
  try{
    const res = await fetch(endpoint,{method:'POST'});
    if(!res.ok){ console.warn('action failed', act, job); return; }
    const js = await res.json();
    // Optimistically update link set without waiting for refresh
    if(act === 'pause' && js.ok){
      // Replace pause with continue
      a.textContent = 'continue';
      a.setAttribute('data-act','continue');
      const tr = a.closest('tr');
      if(tr){
        const sc = tr.querySelector('.status-col');
        if(sc){ sc.textContent = 'paused'; sc.className = sc.className.replace(/status-[^\s]+/,'status-paused'); }
      }
    }else if(act === 'continue' && js.ok){
      a.textContent = 'pause';
      a.setAttribute('data-act','pause');
      const tr = a.closest('tr');
      if(tr){
        const sc = tr.querySelector('.status-col');
        if(sc){ sc.textContent = 'running'; sc.className = sc.className.replace(/status-[^\s]+/,'status-running'); }
      }
    }else if(act === 'delete' && js.ok){
      // Remove row immediately
      const tr = a.closest('tr');
      if(tr) tr.parentNode.removeChild(tr);
    }
    // Also trigger a full refresh soon for consistency
    setTimeout(()=>refreshJobs(), 300);
  }catch(err){ console.error('action err', err); }
});
async function saveJobName(jobId, val, el){
  try{
    const res = await fetch(`/api/job/${jobId}/name`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name: val})
    });
    if(!res.ok){
      el.classList.remove('saving');
      el.classList.add('error');
      return;
    }
    const js = await res.json();
    if(js.ok){
      el.setAttribute('data-last', val);
      el.classList.remove('saving');
      el.classList.add('saved');
      setTimeout(()=>el.classList.remove('saved'), 1600);
    }else{
      el.classList.remove('saving');
      el.classList.add('error');
    }
  }catch(e){
    el.classList.remove('saving');
    el.classList.add('error');
  }
}
</script>
</body>
</html>
